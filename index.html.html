<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte Prospects</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    #status {
      position: absolute; z-index: 1000; top: 10px; left: 50%; transform: translateX(-50%);
      background: #fff; padding: 6px 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.12);
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .error { color: #b91c1c; font-weight: 600; }
  </style>
</head>
<body>

  <!-- ⬇️ Mets ici la SORTIE JSON de l'Array aggregator -->
  <script id="data" type="application/json">{"array":[{"ID":"2025-000572","Notes":"30/07/2025 : Prospect en attente de visite\n30-07-2025 : Résumé aux propriétaire envoyé par mail\n30-07-25: dans une ancienne ferme, 7000m2. Il y a 3 bâtiments, un verger, le garage. Pas de vis à vis. \n17-07-2025 : Mail RDV Carla envoyé\n17/07/2025 : Prospect contacté pour la première fois\n17-07-2025 : Mail RDV Carla envoyé","Nom de l'hôte":"Estelle Lethuillier","Coordonnées GPS":"49.677147, 0.182332"},{"ID":"2025-000571","Notes":"24/07/2025 : Prospect en attente de visite\n24-07-2025 : Mail RDV Carla envoyé\nAccueil des cyclistes gratuitement. Zone agricole de vergers. 4000m2. Monsieur y a son potager. Toilettes ok , \nCamion 6m non possible, \n17-07-2025 : Mail RDV Carla envoyé\n17/07/2025 : Prospect contacté pour la première fois\n16-07-2025 : Résumé aux propriétaire envoyé par mail","Nom de l'hôte":"Franck Espinas","Coordonnées GPS":"42.66241131217827, 2.6746222918048215"},{"ID":"2025-000551","Notes":"23/07/2025 : Prospect en attente de visite\n23-07-2025: ont un gîte, tente lodge, 2 tiny house isolés. Peut démarrer rapidement \n22-07-2025 : rdv a 10h : pas de réponse \n17-07-2025 : Mail RDV Carla envoyé\n17/07/2025 : Prospect contacté pour la première fois","Nom de l'hôte":"Mireille Laty","Coordonnées GPS":"47.64727526022123, 3.0138582834412047"},{"ID":"2025-000544","Notes":"23-07-2025 : Mail RDV Carla envoyé\n23/07/2025 : Prospect en attente de visite\n24/07/2025: normalement plusieurs spot.s possibles. 6,5 hectare au total \n17-07-2025 : Mail RDV Carla envoyé","Nom de l'hôte":"Yohan Jacob","Coordonnées GPS":"44.7645829 1.7419021"},{"ID":"2025-000528","Notes":"22/07/2025 : Prospect en attente de visite\n22-07-2025 : Résumé aux propriétaire envoyé par mail\n22-07-2025: petit bois de 1 petit hectare. Facile d' accès. 3 spots possibles. \nVillage de Lauzerte, ( apprécié des voyageurs, émission plus beaux villages de France) pas loin du chemin de Saint Jacques de Compostelle (8km) . Randonnées, \nA prévenir si les voyageurs ont des chiens. ( Importants) \nToilettes sèches, \n17-07-2025 : Mail RDV Carla envoyé\n19/06/25:sms envoyé","Nom de l'hôte":"Pierre Dupont","Coordonnées GPS":"44.19433666344241, 1.2211557082880504"},{"ID":"2025-000523","Notes":"24/06/24 : Trésorier d'une association , club de voile. Ils ont plusieurs terrains. Une zone OK toute l'année et une autre hors juillet-Août car accueille de centre de loisir. Terrains isolés, peu de passages. Emplacement à 20 M du bord de seine. \n19/06/25:sms envoyé","Nom de l'hôte":"Thomas Guenneguez","Coordonnées GPS":"49.46431968124775, 0.9362044550593988"},{"ID":"2025-000521","Notes":"23/07/2025 : Prospect en attente de visite\n23-07-2025 : Mail RDV Carla envoyé\n24/07/2025: parcelle intéressante de 4000 M2, point de vente , agriculteur. A une autre parcelle où il est sur Home camper et park4night . \n17/07/2025 : Prospect contacté pour la première fois\n17-07-2025 : Mail RDV Carla envoyé","Nom de l'hôte":"Marien Luciani","Coordonnées GPS":"42.166682235993754, 9.177106059249855"},{"ID":"2025-000504","Notes":"24/06/25 : Commercial dans une conception de camping-car. Piscine accessible, la maison est sur le terrain. Il faut passer par le jardin , location piscine OK . 2000M2, \n \n19/06/25: sms envoyé","Nom de l'hôte":"Yannick GUIGNABERT","Coordonnées GPS":"45.00563579810455, 1.5648086945399982"},{"ID":"2025-000502","Notes":"2/07/25: 4*4 ok sinon accès plus compliqué. 2 spots possibles véhicules + tente. Leur maison est à côté.\nÉlec et eau ok si voyageurs dans le besoin. Ambassadeur ?\n10mn a pied de la gare, téléphérique... Chamonix, St Gervais. \nTerrain de pétanque \n\n19/06/25:sms envoyé","Nom de l'hôte":"Yannick Beaudeau","Coordonnées GPS":"45.901336,6.696464"},{"ID":"2025-000499","Notes":"24/06/2025 : 2500M2 Barbecue OK , 1 spot . Très reposant, pas un bruit. 4km d'un lac ( plage, accrobranche, snack...) A Culan saut à l'élastique à 5km. \n19/06/25: sms envoyé","Nom de l'hôte":"erik piotr","Coordonnées GPS":"46.522166, 2.313290"},{"ID":"2025-000484","Notes":"Ont envie de monter un camping , est intéressé par le projet ambassadeur.\n1ha de bois en pente. La moitié en pente pour le moment. \nTransmettre le contact à Pierre Henri. \nA rencontrer en Août , ","Nom de l'hôte":"Gildas QUEINNEC","Coordonnées GPS":"48.0906, -4.3129"},{"ID":"2025-000488","Notes":"24/06/25: chez eux, dans un village mais protégé des vis à vis. En bord de ruisseau, baignade non accessible. \n19/06/25:sms envoyé","Nom de l'hôte":"Sandrine Durin","Coordonnées GPS":"47.257552,5.512593"},{"ID":"2025-000474","Notes":"12/06/2025 : 4000m2, souhaite 2 voyageurs pas plus. N'ont pas d'autres terrains. Vont construire leur maison principale sur le terrains à partir de septembre. Le proprio dit qu'il y aura peu de vis à vis .","Nom de l'hôte":"Marlon Koppe","Coordonnées GPS":"44.2358647173232, 6.753047351340549"},{"ID":"2025-000478","Notes":"02/06/2025 : est déjà propriétaire de terrains, nous propose celui ci en complément","Nom de l'hôte":"Pascal Chavernac","Coordonnées GPS":"43.301758525777, 2.821126035380446"},{"ID":"2025-000471","Notes":"02/06/2025: en légère pente . Donne sur un lac , en pleine campagne. Toilettes à proximité accessible.  Rando, vélo, \nUn seul spot : 35%","Nom de l'hôte":"Olivier Roche","Coordonnées GPS":"44.895521, 4.652584"},{"ID":"2025-000435","Notes":"26/05/2025: A l'origine terrain de Paintball, 7000M2. Verger , vue sur les champs . En bord de route, passage de voiture de temps en temps. ","Nom de l'hôte":"Patrick COLET","Coordonnées GPS":"48.39931280206073, 3.612759060952058"},{"ID":"2025-000431","Notes":"@05/06 : SMS accord pour en attente de visite\n26/05/2025:Superficie , terrain de 2000 M2 . 700M2 de plat . \nParcours santé, parcours pieds nus, Château de Stanislas . Réserve naturelle,  Doit voir auprès de la mairie et de sa femme.","Nom de l'hôte":"Julien Etienne","Coordonnées GPS":"48.77639513009027, 5.590482997382633"},{"ID":"2025-000373","Notes":"21/05/2025: coordonnées GPS à demander avant la visite.  SUPER SPOTSPas d'habitation, était auparavant un camping. Il y a une très jolie vue, pas de VIs à Vis. Bonne accessibilité.  Terrain à 1500M d'altitude, 3ha. La moitié de bois, 1ha8 qui sont des champs. \nNe sera pas dispo pour la visite.  Prêt pour la saison . La randonnée, à =8km du col de Turini, direction vers la mer des merveilles. Mercantour, \n09/05/2025: SMS envoyé","Nom de l'hôte":"philippe BAU","Coordonnées GPS":"43.97769289711722, 7.391096956372177"},{"ID":"2025-000342","Notes":"02/07/2025 : mail reçu, il préfère une visite à partir de septembre\n16/04/2025: 2000m2, un petit peu vallonée , une petite zone de stationnement sera. \n15/04/2025: SMS envoyé ->  A contacter demain matin","Nom de l'hôte":"Laybros Aurelien","Coordonnées GPS":"45.0693502, 2.1529622"},{"ID":"2025-000338","Notes":"15/04/2025: vignes et bois. hospitalisé pendant 1 mois . Disponible début mai","Nom de l'hôte":"VIALA Jonathan","Coordonnées GPS":"43.9674313823695, 4.062250069940292"},{"ID":"2025-000335","Notes":"10/04/2025: 2000M2, Route à proximité peu passante. Pas accessible l'hiver. Tout n'est pas plat, il faudra identifier les spots. Il y a un chalet sur le site, toilettes, douches ( ouverture sous demande).Veut faire potentiellement du AIRBNB.  Va réfléchir pour trouver d'autres spots .(famille, ami... )  . \n09/04/2025: SMS envoyé","Nom de l'hôte":"Pierrick AUGUSTE","Coordonnées GPS":"46.030202030905755, 6.272341696968539"},{"ID":"2025-000333","Notes":"09/04/2025: A peur que son terrain soit trop identifiable avant la réservation.  0 visà vis, Départementale à 100M  ( faire attention pendant la visite)mais site entourée d'arbes.  . Chalet sur le site avec un coin cusine, canapé, évier, meuble cuisson au gaz. superficie: 2500M2, au bord d'un étang. (vide l'été souvent) Il y a plusieurs petits coins. Pas accessible en hiver ","Nom de l'hôte":"Benoît Thévard","Coordonnées GPS":"47.85528060066917, 2.2452482478507534"},{"ID":"2025-000331","Notes":"07/04/2025: Collabore déjà chez Homecamper, mais fermera les journées si il y a trop de monde. Réserve naturelle, la nature est privilégié.  Observatoire d'oiseaux à proxilité à pied, lacs pas loin, vélo autour du lac. Toilettes sèches, douche solaire, distribution d'eau, frigidaire ... Location de tente possible. ","Nom de l'hôte":"Matouillot Patricia","Coordonnées GPS":"48.355885699172546, 4.4983692410157525"}],"__IMTAGGLENGTH__":23}</script>

  <div id="status">Initialisation…</div>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const $status = document.getElementById('status');
    const setStatus = (msg, err=false) => {
      $status.innerHTML = err ? '<span class="error">' + msg + '</span>' : msg;
      (err ? console.error : console.log)(msg);
    };

    // 1) Carte (toujours affichée)
    const map = L.map('map').setView([46.7, 1.7], 6);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2) Lecture des données (gère array / Mapping / map)
    let recs = [];
    let raw = document.getElementById('data')?.textContent || '[]';
    try {
      const payload = JSON.parse(raw);

      if (Array.isArray(payload)) {
        recs = payload;
      } else if (payload && Array.isArray(payload.array)) {
        recs = payload.array;                 // <-- ton cas
      } else if (payload && Array.isArray(payload.Mapping)) {
        recs = payload.Mapping;
      } else if (payload && Array.isArray(payload.map)) {
        recs = payload.map;
      } else if (payload && payload.json !== undefined) {
        let inner = typeof payload.json === 'string' ? JSON.parse(payload.json) : payload.json;
        if (Array.isArray(inner)) recs = inner;
        else if (inner && Array.isArray(inner.map)) recs = inner.map;
      }
    } catch (e) {
      setStatus('JSON invalide. Début: ' + raw.slice(0, 120) + (raw.length > 120 ? '…' : ''), true);
      recs = [];
    }

    // 3) Helpers
    const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    // Parser tolérant : prend les 2 premiers nombres (gère virgules décimales / espaces / virgule)
    const parseLL = t => {
      const m = String(t||'').match(/-?\d+(?:[.,]\d+)?/g);
      if (!m || m.length < 2) return null;
      const lat = parseFloat(m[0].replace(',', '.'));
      const lon = parseFloat(m[1].replace(',', '.'));
      return (isFinite(lat) && isFinite(lon)) ? [lat, lon] : null;
    };

    // 4) Marqueurs
    const bounds = [];
    let withGps = 0, shown = 0;
    (Array.isArray(recs) ? recs : []).forEach(it => {
      if (it && it["Coordonnées GPS"]) withGps++;
      const ll = parseLL(it && it["Coordonnées GPS"]);
      if (!ll) return;
      L.marker(ll)
  .addTo(map)
  .bindPopup(
    `<b>${esc(it["Nom de l'hôte"])}</b><br>` +
    `<i>ID: ${esc(it["ID"])}</i><br>` +
    `${esc(it["Notes"])}`
  );
      bounds.push(ll);
      shown++;
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });

    setStatus(`Objets: ${Array.isArray(recs)?recs.length:0} · Avec GPS: ${withGps} · Points affichés: ${shown}`);
  </script>
</body>
</html>